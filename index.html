<!doctype html>
<html>
	<head>
		
	</head>
	<body>

		<template>
			<style>
				.scroll-bar {
					width: 15px;
					background-color: lightgrey;
					position: absolute;
					top:0;
					left:100%;
					bottom:0;
				}
				.scroll-bar.horizontal {
					height: 15px;
					width: 100%;
					background-color: gold;
					position: absolute;
					left:0;
					right: 100%;
					top:100%;
				}

				scroll-bar-up{
					position: absolute;
					top: 0;
					width: 15px;
					height: 15px;
					background-color: darkgrey;
				}
				
				.scroll-bar.horizontal scroll-bar-up{
					position: absolute;
					top: 0;
					width: 15px;
					height: 15px;
					background-color: darkgrey;
				}

				scroll-bar-thumb {
					background-color: steelblue;
					width: 15px;
					height: 20px;
					top: 15px;
					position: absolute;
				}
				.scroll-bar.horizontal scroll-bar-thumb {
					background-color: steelblue;
					height: 15px;
					width: 20px;
					left: 15px;
					top: 0;
					position: absolute;
				}

				scroll-bar-down{
					position: absolute;
					right: 0;
					bottom: 0;
					width: 15px;
					height: 15px;
					background-color: darkgrey;
				}
				.scroll-bar.horizontal scroll-bar-down{
					position: absolute;
					right: 0;
					width: 15px;
					height: 15px;
					background-color: darkgrey;
				}
				
			</style>
			<div class="scroll-bar">
				<scroll-bar-up></scroll-bar-up>
				<scroll-bar-thumb draggable="false"></scroll-bar-thumb>
				<scroll-bar-down></scroll-bar-down>
			</div>
		</template>
		
		<script>


			// Adapted form http://live.exept.de/ClassDoc/classDocOf:,RangeAdaptor
			// Range Adaptor is a kind of UpdateAdaptor that can be used to turn an 
			// arbitrary number (either an Integer or a Float) into a Float normalized between
			// 0 and 1.
			var RangeAdapter = function(subjectValue, start, stop, gridValue){
				var that = this,
						value = subjectValue,
						rangeStart = start, 
						rangeStop = stop, 
						grid = gridValue;

				// this is the 'cached' value that is listenable
				that.valueObj = {value:null};

				Object.observe(value,function(changeSet){
					console.log(changeSet);
					that.valueObj.value = that.getValue(changeSet[0].object.value);
					console.log(value); 
				});

				that.grid = function(value){
					if (value === undefined) {
						return grid;
					}
					grid = value;
				};

				that.rangeStart = function(value){
					if(value === undefined){
						return rangeStart;
					}
				};

				that.rangeStop = function(value){
					if (value === undefined){
						return rangeStop;
					}
				};

				// @param value is a number
				that.setValue = function(newValue){
					if (!typeof value === 'number'){
						return;
					}
					value = newValue;
				};

				
				that.getValue = function(subjectValue){
					value = (subjectValue - rangeStart) / (rangeStop - rangeStart);
					return value;
				};

			};



			//register the scrollbar elements
			(function(){

				var importDoc = document.currentScript.ownerDocument;

				// An instance of his will become the prototype for the custom scroll-bar
				// element 
				var ScrollBar = function(){
				};

				ScrollBar.prototype = Object.create(HTMLElement.prototype);

				ScrollBar.prototype.setRangeAdapter = function(rangeAdapter) {
					var that = this;

					that.rangeAdapter = rangeAdapter;
					that.thumb.rangeAdapter = rangeAdapter;

					Object.observe(rangeAdapter.valueObj, function(change){
						that.thumb.moveToPercent(change[0].object.value)
					});


				};

				// the createdCallback method will be called by the native code 
				ScrollBar.prototype.attachedCallback = function() {
					var scrollbarTemplate = importDoc.querySelector('template'),
							scrollBarImportClone = document.importNode(scrollbarTemplate.content,true),
							scrollbarShadowRoot = this.createShadowRoot();

					scrollbarShadowRoot.appendChild(scrollBarImportClone);

					// get the actionable child elements 
					this.bar = scrollbarShadowRoot.querySelector('.scroll-bar');
					this.thumb = scrollbarShadowRoot.querySelector('scroll-bar-thumb');
					this.btnUp = scrollbarShadowRoot.querySelector('scroll-bar-up');
					this.btnDown = scrollbarShadowRoot.querySelector('scroll-bar-down');

					this.configureOrientation();
				};

				ScrollBar.prototype.configureOrientation = function() {
					var orientation = 'y'; 

					if ('horizontal' in this.attributes){
						orientation = 'x';
						this.bar.classList.add('horizontal');
					} 

					this.thumb.setOrientation(orientation);
				};


				// we only talk value models now 
				
				// ScrollBar.prototype.registerScrollMoveCallback = function(callback) {
				// 	var that = this;

				// 	this.thumb.registerScrollMoveCallback(function(move) {
						
				// 		callback(move);
				// 	})
				// };

				var scrollBarUpProto = Object.create(HTMLElement.prototype, {});

				var scrollBarThumbProto = Object.create(HTMLElement.prototype, {
					createdCallback : {
						value : function(event){
							var that = this;

							that.isScrolling = false;

							this.addEventListener('mousedown',function(event){
								that.isScrolling = true;						
								that.initialLocation = event[that.orientation];
							});
							document.addEventListener('mousemove',function(event){
								if (that.isScrolling) {
									var location = event[that.orientation] - that.initialLocation + (that.translated || 0);

									that.moveThumb(location);
								 }
							});
							document.addEventListener('mouseup',function(event){
								if(that.isScrolling) {
									that.isScrolling = false;
									that.translated = event[that.orientation] - that.initialLocation + (that.translated || 0);
									
								}
							});
						}
					},
					moveThumb: {
						value: function(location){

							var that = this,
									range =  that.getMaxScroll(); 

							//keep the scrolling in range
							location = (location ) < 0 ? 0 : location;
							location = (location ) > range ? range : location;

							requestAnimationFrame(function(){
								var axis = that.orientation.toUpperCase();
								that.style.webkitTransform = 'translate'+axis+'('+ location +'px)';

								if (that.rangeAdapter){
									console.log('ill set you', location / that.getMaxScroll());
									that.rangeAdapter.valueObj.value = location / that.getMaxScroll();
								}
							});	
						}//end movethumb value
					},
					moveToPercent: {
						value: function(percent){
							// if already dragging, dont respect the observable value sets
							if (!that.isScrolling) {
								this.moveThumb(percent * this.getMaxScroll());
							}
						}
					},
					getLcoation: {
						value: function(){
							return (that.translated || 0) / that.getMaxScroll() * 100;
						}
					},
					// we only talk value models here now 
					// registerScrollMoveCallback: {
					// 	value: function(callback){
					// 		this.scrollMoveCallback = callback;
					// 	}
					// },
					setValueUpdatedCallback: {
						value: function(callback){
							this.valueUpdatedCallback = callback;
						}
					},
					setOrientation : {
						value: function(orientation){
							console.log('this is the orientation', orientation);
							this.orientation = orientation;
						}
					},
					getMaxScroll :{
						value: function(){
							var direction = this.orientation === 'y' ? 'clientHeight' : 'clientWidth'
							return this.parentNode[direction] - 50;
						}
					}
				});

				var scrollBarDownProto = Object.create(HTMLElement.prototype, {});
				
				document.registerElement('scroll-bar-up', {
					prototype: scrollBarUpProto
				});
				document.registerElement('scroll-bar-thumb', {
					prototype: scrollBarThumbProto
				});
				document.registerElement('scroll-bar-down', {
					prototype: scrollBarDownProto
				});
				document.registerElement('scroll-bar', {
					prototype: new ScrollBar()
				});
			})()

		</script>
	</body>
</html>