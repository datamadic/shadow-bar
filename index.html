<!doctype html>
<html>
	<head>
		<link title="scrollbar" rel="import" href="../components/scrollbar.html">
	</head>
	<body>

		<template>
			<style>
				.scroll-bar {
					width: 15px;
					background-color: lightgrey;
					position: absolute;
					top:0;
					left:100%;
					bottom:0;
				}
				.scroll-bar.horizontal {
					height: 15px;
					width: 100%;
					background-color: gold;
					position: absolute;
					left:0;
					right: 100%;
					top:100%;
				}

				scroll-bar-up{
					position: absolute;
					top: 0;
					width: 15px;
					height: 15px;
					background-color: darkgrey;
				}
				
				.scroll-bar.horizontal scroll-bar-up{
					position: absolute;
					top: 0;
					width: 15px;
					height: 15px;
					background-color: darkgrey;
				}

				scroll-bar-thumb {
					background-color: steelblue;
					width: 15px;
					height: 20px;
					top: 15px;
					position: absolute;
				}
				.scroll-bar.horizontal scroll-bar-thumb {
					background-color: steelblue;
					height: 15px;
					width: 20px;
					left: 15px;
					top: 0;
					position: absolute;
				}

				scroll-bar-down{
					position: absolute;
					right: 0;
					width: 15px;
					height: 15px;
					background-color: darkgrey;
				}
				.scroll-bar.horizontal scroll-bar-down{
					position: absolute;
					left: 0;
					width: 15px;
					height: 15px;
					background-color: darkgrey;
				}
				
			</style>
			<div class="scroll-bar">
				<scroll-bar-up></scroll-bar-up>
				<scroll-bar-thumb draggable="false"></scroll-bar-thumb>
				<scroll-bar-down></scroll-bar-down>
			</div>
		</template>
		
		<script>

			//register the scrollbar elements
			(function(){

				var importDoc = document.currentScript.ownerDocument;

				var scrollBarProto = Object.create(HTMLElement.prototype, {
					createdCallback: {
						value: function(){
							// set up the template 
							var scrollbarTemplate = importDoc.querySelector('template'),
									scrollBarImportClone = document.importNode(scrollbarTemplate.content,true),
									scrollbarShadowRoot = this.createShadowRoot();

							scrollbarShadowRoot.appendChild(scrollBarImportClone);

							// get the actionable child elements 
							this.bar = scrollbarShadowRoot.querySelector('.scroll-bar');
							this.thumb = scrollbarShadowRoot.querySelector('scroll-bar-thumb');
							this.btnUp = scrollbarShadowRoot.querySelector('scroll-bar-up');
							this.btnDown = scrollbarShadowRoot.querySelector('scroll-bar-down');

							this.configureOrientation();

						}
					},
					configureOrientation : {
						value: function(){
							//console.log(this.getAttribute('horizontal'), 'horizontal' in this.attributes );
							var orientation = 'y'; 

							if ('horizontal' in this.attributes){
								orientation = 'x';
								this.bar.classList.add('horizontal');
							} 

							this.thumb.setOrientation(orientation);

						}
					},
					registerScrollMoveCallback: {
						value: function(callback){
							this.thumb.registerScrollMoveCallback(function(move) {
								console.log(move)
							})
						}
					}
				});
				var scrollBarUpProto = Object.create(HTMLElement.prototype, {});
				var scrollBarThumbProto = Object.create(HTMLElement.prototype, {
					createdCallback : {
						value : function(event){
							var self = this;

							self.isScrolling = false;

							this.addEventListener('mousedown',function(event){
								self.isScrolling = true;						
								self.initialLocation = event[self.orientation];
							});
							document.addEventListener('mousemove',function(event){
								if (self.isScrolling) {
									var location = event[self.orientation] - self.initialLocation + (self.translated || 0),

											//account for scroll buttons + thumb 
											scrollTill =  self.getMaxScroll(); 

									console.log(self.getMaxScroll());
									
									//keep the scrolling in range
									location = (location ) < 0 ? 0 : location;
									location = (location ) > scrollTill ? scrollTill : location;

									requestAnimationFrame(function(){
										var axis = self.orientation.toUpperCase();
										self.style.webkitTransform = 'translate'+axis+'('+ location +'px)';
										if(self.scrollMoveCallback){
											self.scrollMoveCallback({
												event: event,
												percent: location / scrollTill * 100
											});
										}
									});	
								}
							});
							document.addEventListener('mouseup',function(event){
								if(self.isScrolling) {
									self.isScrolling = false;
									self.translated = event[self.orientation] - self.initialLocation + (self.translated || 0);
								}
							});
						}
					},
					registerScrollMoveCallback: {
						value: function(callback){
							this.scrollMoveCallback = callback;
						}
					},
					setOrientation : {
						value: function(orientation){
							console.log('this is the orientation', orientation);
							this.orientation = orientation;
						}
					},
					getMaxScroll :{
						value: function(){
							var direction = this.orientation === 'y' ? 'clientHeight' : 'clientWidth'
							return this.parentNode[direction] - 50;
						}
					}
				});
				var scrollBarDownProto = Object.create(HTMLElement.prototype, {});

				
				document.registerElement('scroll-bar-up', {
					prototype: scrollBarUpProto
				});
				document.registerElement('scroll-bar-thumb', {
					prototype: scrollBarThumbProto
				});
				document.registerElement('scroll-bar-down', {
					prototype: scrollBarDownProto
				});
				document.registerElement('scroll-bar', {
					prototype: scrollBarProto
				});
			})()
		</script>
	</body>
</html>